<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MNIST Conv2D - Interactive Explorer</title>
    <style>
        body { margin: 0; background: #050505; color: #eee; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #ui { 
            position: absolute; top: 10px; left: 10px; z-index: 1000; 
            background: rgba(15, 15, 15, 0.95); padding: 20px; 
            border: 1px solid #00d4ff; border-radius: 12px; 
            width: 320px; box-shadow: 0 0 30px rgba(0,212,255,0.3);
            max-height: 95vh; overflow-y: auto;
        }

        .section { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        label { font-size: 0.7rem; color: #00d4ff; text-transform: uppercase; letter-spacing: 1.5px; display: block; margin-bottom: 8px; }

        select, input[type="range"] { width: 100%; margin-bottom: 10px; cursor: pointer; background: #222; color: white; border: 1px solid #444; border-radius: 4px; padding: 8px; }

        .kernel-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 15px; }
        .kernel-grid input { 
            width: 100%; background: #111; border: 1px solid #00d4ff; 
            color: #ffca28; text-align: center; padding: 8px 0; 
            border-radius: 6px; font-weight: bold; font-size: 1rem;
        }

        .btn-group { display: flex; flex-direction: column; gap: 8px; }
        button { 
            width: 100%; padding: 12px; border: none; border-radius: 6px; 
            cursor: pointer; font-weight: bold; font-size: 0.85rem; transition: 0.2s; 
        }
        .btn-next { background: #00ffcc; color: #000; }
        .btn-random { background: #ffca28; color: #000; }
        .btn-update { background: #00d4ff; color: #000; }
        
        .stat-box { background: #111; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.9rem; margin-top: 10px;}
        .highlight { color: #00ffcc; font-weight: bold; }
    </style>
</head>
<body>

<div id="ui">
    <div class="section">
        <label>1. Dataset Control</label>
        <button class="btn-next" onclick="nextImage()">üñºÔ∏è NEXT MNIST IMAGE</button>
        <div style="margin-top: 8px; font-size: 0.85rem;">Current Digit: <span id="digit-label" class="highlight">7</span></div>
    </div>

    <div class="section">
        <label>2. Filter Presets</label>
        <select id="filter-preset" onchange="applyPreset()">
            <option value="sobel">Sobel (Edge Detection)</option>
            <option value="prewitt">Prewitt (Edge Detection)</option>
            <option value="gaussian">Gaussian (Blur)</option>
            <option value="laplacian">Laplacian (Sharpen)</option>
            <option value="identity">Identity</option>
        </select>
        
        <div style="display: flex; justify-content: space-between;">
            <label>Scan Speed</label>
            <span id="speed-display" class="highlight">20 ms</span>
        </div>
        <input type="range" id="speed-slider" min="5" max="100" value="20" oninput="updateSpeed(this.value)">
    </div>

    <div class="section">
        <label>3. Kernel Weights</label>
        <div class="kernel-grid" id="k-inputs">
            <input type="number" step="0.1" value="-1" onchange="manualEdit()"> <input type="number" step="0.1" value="0" onchange="manualEdit()"> <input type="number" step="0.1" value="1" onchange="manualEdit()">
            <input type="number" step="0.1" value="-2" onchange="manualEdit()"> <input type="number" step="0.1" value="0" onchange="manualEdit()"> <input type="number" step="0.1" value="2" onchange="manualEdit()">
            <input type="number" step="0.1" value="-1" onchange="manualEdit()"> <input type="number" step="0.1" value="0" onchange="manualEdit()"> <input type="number" step="0.1" value="1" onchange="manualEdit()">
        </div>
        
        <div class="btn-group">
            <button class="btn-random" onclick="randomizeKernel()">üé≤ RANDOMIZE WEIGHTS</button>
            <button class="btn-update" onclick="updateKernel()">RESTART SCAN</button>
        </div>
    </div>

    <div class="stat-box">
        Pixel Sum (Dot Product): <span id="calc-val" class="highlight">0.00</span>
    </div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    let scene, camera, renderer, step = 0, lastTime = 0;
    let currentDigitIndex = 7;
    // Set default throttle to 20ms
    window.throttle = 20; 
    
    const size = 28;
    const inputData = [];
    const inputMeshes = [];
    const outputGrid = [];
    let kernel = [];
    let kernelVisualGroup = new THREE.Group();

    const presets = {
        sobel: [[-1, 0, 1], [-2, 0, 2], [-1, 0, 1]],
        prewitt: [[-1, 0, 1], [-1, 0, 1], [-1, 0, 1]],
        gaussian: [[0.06, 0.12, 0.06], [0.12, 0.25, 0.12], [0.06, 0.12, 0.06]],
        laplacian: [[0, 1, 0], [1, -4, 1], [0, 1, 0]],
        identity: [[0, 0, 0], [0, 1, 0], [0, 0, 0]]
    };

    function generateDigitData(digit) {
        let data = Array(size).fill(0).map(() => Array(size).fill(0.08));
        const mid = 14;
        for(let y=0; y<size; y++) {
            for(let x=0; x<size; x++) {
                let draw = false;
                if (digit === 7) draw = (y === 7 && x > 7 && x < 21) || (x + y === 28 && x > 7 && x < 21);
                if (digit === 0) draw = Math.abs(Math.sqrt((x-mid)**2 + (y-mid)**2) - 7) < 1.5;
                if (digit === 1) draw = x === 14 && y > 5 && y < 23;
                if (digit === 4) draw = (x === 18 && y > 5 && y < 23) || (y === 16 && x > 6 && x < 22) || (x+y === 22 && x > 6 && x < 14);
                if (digit === 8) draw = Math.abs(Math.sqrt((x-mid)**2 + (y-10)**2) - 4) < 1.2 || Math.abs(Math.sqrt((x-mid)**2 + (y-18)**2) - 4) < 1.2;
                if (digit === 2) draw = (y===7 && x>7 && x<21) || (y===21 && x>7 && x<21) || (y===14 && x>7 && x<21) || (x===21 && y>7 && y<14) || (x===7 && y>14 && y<21);
                if (draw) data[y][x] = 0.9 + Math.random() * 0.1;
            }
        }
        return data;
    }

    window.nextImage = () => {
        const digits = [0, 1, 2, 4, 7, 8];
        currentDigitIndex = digits[(digits.indexOf(currentDigitIndex) + 1) % digits.length];
        document.getElementById('digit-label').innerText = currentDigitIndex;
        const newData = generateDigitData(currentDigitIndex);
        for(let y=0; y<size; y++) {
            for(let x=0; x<size; x++) {
                inputData[y][x] = newData[y][x];
                inputMeshes[y][x].material.color.setRGB(newData[y][x], newData[y][x], newData[y][x]);
            }
        }
        window.updateKernel();
    };

    window.updateSpeed = (val) => { 
        window.throttle = parseInt(val);
        document.getElementById('speed-display').innerText = val + " ms";
    };

    window.randomizeKernel = () => {
        document.querySelectorAll('#k-inputs input').forEach(i => i.value = (Math.random() * 4 - 2).toFixed(1));
        window.updateKernel();
    };

    window.applyPreset = () => {
        const type = document.getElementById('filter-preset').value;
        const p = presets[type].flat();
        document.querySelectorAll('#k-inputs input').forEach((input, i) => input.value = p[i]);
        window.updateKernel();
    };

    window.manualEdit = () => { window.updateKernel(); };

    window.updateKernel = () => {
        const inputs = document.querySelectorAll('#k-inputs input');
        kernel = [
            [parseFloat(inputs[0].value), parseFloat(inputs[1].value), parseFloat(inputs[2].value)],
            [parseFloat(inputs[3].value), parseFloat(inputs[4].value), parseFloat(inputs[5].value)],
            [parseFloat(inputs[6].value), parseFloat(inputs[7].value), parseFloat(inputs[8].value)]
        ];
        
        kernelVisualGroup.children.forEach((mesh, i) => {
            const val = kernel[Math.floor(i/3)][i%3];
            const intensity = Math.min(Math.abs(val), 1.0);
            if(val > 0) mesh.material.color.setRGB(intensity, intensity, intensity);
            else if(val < 0) mesh.material.color.setRGB(intensity, 0, 0);
            else mesh.material.color.setRGB(0.1, 0.1, 0.1);
        });

        step = 0;
        outputGrid.flat().forEach(p => p.material.color.setHex(0x111111));
    };

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(14, 38, 48); camera.lookAt(14, 0, 14);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const initialData = generateDigitData(currentDigitIndex);

        for (let y = 0; y < size; y++) {
            inputData[y] = []; inputMeshes[y] = [];
            for (let x = 0; x < size; x++) {
                inputData[y][x] = initialData[y][x];
                const mesh = new THREE.Mesh(new THREE.PlaneGeometry(0.95, 0.95), new THREE.MeshBasicMaterial({ color: new THREE.Color(inputData[y][x], inputData[y][x], inputData[y][x]) }));
                mesh.position.set(x, 0, y); mesh.rotation.x = -Math.PI/2;
                scene.add(mesh);
                inputMeshes[y][x] = mesh;
            }
        }

        for (let y = 0; y < size - 2; y++) {
            outputGrid[y] = [];
            for (let x = 0; x < size - 2; x++) {
                const mesh = new THREE.Mesh(new THREE.PlaneGeometry(0.95, 0.95), new THREE.MeshBasicMaterial({ color: 0x111111 }));
                mesh.position.set(x + 35, 0, y + 1); mesh.rotation.x = -Math.PI/2;
                scene.add(mesh);
                outputGrid[y][x] = mesh;
            }
        }

        for(let i=0; i<9; i++) {
            const kPart = new THREE.Mesh(new THREE.PlaneGeometry(0.9, 0.9), new THREE.MeshBasicMaterial({ transparent: true, opacity: 0.8 }));
            kPart.position.set((i%3)-1, 0.1, Math.floor(i/3)-1); kPart.rotation.x = -Math.PI/2;
            kernelVisualGroup.add(kPart);
        }
        scene.add(kernelVisualGroup);

        window.updateKernel();
        animate();
    }

    function animate(currentTime) {
        requestAnimationFrame(animate);
        if (currentTime - lastTime < window.throttle) return;
        lastTime = currentTime;

        const limit = size - 2;
        const outX = step % limit; const outY = Math.floor(step / limit);

        let sum = 0;
        for (let ky = 0; ky < 3; ky++) {
            for (let kx = 0; kx < 3; kx++) {
                sum += inputData[outY + ky][outX + kx] * kernel[ky][kx];
            }
        }

        kernelVisualGroup.position.set(outX + 1, 0.2, outY + 1);
        const intensity = Math.min(Math.max(Math.abs(sum), 0), 1.0);
        outputGrid[outY][outX].material.color.setRGB(intensity, intensity, intensity);
        document.getElementById('calc-val').innerText = sum.toFixed(2);

        step = (step + 1) % (limit * limit);
        renderer.render(scene, camera);
    }
    init();
</script>
</body>
</html>